#!/bin/bash
set -e
cd "$OPENQA_BASEDIR/repos/openQA"
what=$1
shift || true

declare -A shortcuts=(
    [wu]=webui
    [lv]=live
    [wu2]=webui2
    [ws]=websockets
    [ra]=resource-allocator
    [sc]=scheduler
    [wo]=worker
    [wc]=workercache
    [wm]=workercache-minion
    [gr]=gru
    [cj]=clone-job
    [jc]=clone-job
    [job-clone]=job-clone
)

if [[ $what == '' ]] || [[ $what == --help ]] || [[ $what == -h ]]; then
    echo "Starts an openQA daemon using repos and test data within $OPENQA_BASEDIR"
    echo "usage: $0 daemon [args]"
    echo "where daemon is one of:"
    echo "   shortcut | long daemon name"
    for daemon in wu lv ws ra sc wo sc wc wm gr cj; do
        echo "   $daemon       | ${shortcuts[$daemon]}"
    done
    echo "args are forwarded to the specified daemon"
    echo "set OPENQA_BASE_PORT to customize ports (see README.md)"
    exit 0
fi

what=${shortcuts[$what]:-$what}

if [[ $OPENQA_BASE_PORT ]]; then
    declare -A ports=(
        [webui]=0
        [websockets]=1
        [live]=2
        [scheduler]=3
    )
    instance_port=${ports[$what]}
    if [[ $instance_port == '' ]]; then
        echo "OPENQA_BASE_PORT not supported for $what"
        exit -1
    fi
    export OPENQA_CONFIG=$OPENQA_CONFIG/$OPENQA_BASE_PORT
    export MOJO_LISTEN=http://127.0.0.1:$(($OPENQA_BASE_PORT + $instance_port))
fi

function start_script {
    echo "$@"
    if [[ $PERL_DEBUGGER_GUI ]]; then
        perl -d:ptkdb "$@"
    elif [[ $PERL_ARGS ]]; then
        perl $PERL_ARGS "$@"
    else
        "$@"
    fi
}

if [[ $what == webui ]]; then
    start_script script/openqa daemon "$@"
elif [[ $what == webui2 ]]; then
    start_script script/openqa daemon -l http://127.0.0.1:12345 "$@"
elif [[ $what == gru ]]; then
    start_script script/openqa gru "$@"
elif [[ $what == gru-run ]]; then
    start_script script/openqa gru run "$@"
elif [[ $what == live ]]; then
    start_script script/openqa-livehandler daemon "$@"
elif [[ $what == client ]]; then
    start_script script/client --host localhost:9526 --apikey $OPENQA_KEY --apisecret $OPENQA_SECRET "$@"
elif [[ $what == worker ]]; then
    start_script script/worker --isotovideo "$OPENQA_BASEDIR/repos/os-autoinst/isotovideo" --instance 1 --no-cleanup --verbose --apikey $OPENQA_KEY --apisecret $OPENQA_SECRET "$@"
elif [[ $what == workercache ]]; then
    start_script script/openqa-workercache daemon "$@"
elif [[ $what == workercache-minion ]]; then
    start_script script/openqa-workercache minion worker "$@"
elif [[ $what == clone-job ]] || [[ $what == job-clone ]]; then
    start_script script/openqa-clone-job --dir "$OPENQA_BASEDIR/openqa/share/factory" --apikey $OPENQA_KEY --apisecret $OPENQA_SECRET --host localhost:9526 "$@"
elif [[ $what == all ]]; then
    source "$OPENQA_BASEDIR/repos/openQA-helper/lib/tabs.sh"
    sessions=(
        openQA-webui               'wu'
        openQA-live                'lv'
        openQA-websockets          'ws'
        openQA-GRU                 'gru-run'
        openQA-scheduler           'sc'
        openQA-worker1             'wo'
    )
    start_sessions ${sessions[@]}
elif [[ -x script/openqa-$what ]]; then
    start_script script/openqa-"$what" "$@"
elif [[ -x script/$what ]]; then
    start_script script/"$what" "$@"
else
    echo "Script \"$what\" not found."
    exit -1
fi
